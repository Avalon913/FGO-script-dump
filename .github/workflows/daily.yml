name: Auto Dump FGO Scripts (no txt + updates only NEW story files)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "2,12 * * * *"   # UTC = Âåó‰∫¨Êó∂Èó¥ÊØèÂ∞èÊó∂ 10 / 20 ÂàÜ

jobs:
  dump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Atlas Academy game data
        run: |
          rm -rf atlas-data
          git clone --depth 1 https://git.atlasacademy.io/atlasacademy/fgo-game-data.git atlas-data

      - name: Sync Script + updates/YYYY-MM-DD (updates = NEW story files only)
        shell: bash
        run: |
          set -euo pipefail

          DATE="$(date +%F)"   # UTC date

          mkdir -p Script
          mkdir -p "updates/$DATE"

          # Fix conflict: Script/ScriptFileList file vs directory
          if [ -e "Script/ScriptFileList" ] && [ ! -d "Script/ScriptFileList" ]; then
            rm -f "Script/ScriptFileList"
          fi

          while IFS= read -r -d '' f; do
            rel="${f#atlas-data/ScriptActionEncrypt/}"
            out="Script/${rel%.txt}"
            upd="updates/$DATE/${rel%.txt}"

            mkdir -p "$(dirname "$out")"
            mkdir -p "$(dirname "$upd")"

            # NEW file
            if [ ! -f "$out" ]; then
              cp "$f" "$out"

              # only NEW story files go to updates
              if grep -a -q -E '^(Ôº†|Ôºü[0-9]+Ôºö)' "$f"; then
                cp "$f" "$upd"
              fi

            # existing but changed
            elif ! cmp -s "$f" "$out"; then
              cp "$f" "$out"
            fi
          done < <(find atlas-data/ScriptActionEncrypt -type f -name "*.txt" -print0)

          # Safety cleanup
          find Script -type f -name "*.txt" -delete || true

      - name: Commit and push (skip if no changes)
        id: commit_push
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add Script updates

          if git diff --cached --quiet; then
            echo "No changes, skip commit."
            echo "committed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "auto: update scripts ($(date +%F))"
            git push
            echo "committed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Telegram (only when new files in updates/)
        if: ${{ steps.commit_push.outputs.committed == 'true' }}
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        shell: bash
        run: |
          set -euo pipefail
          DATE="$(date +%F)"

          NEW_PATHS=$(git diff --name-status HEAD~1..HEAD \
            | awk '$1=="A" {print $2}' \
            | grep -E "^updates/${DATE}/" || true)

          if [ -z "$NEW_PATHS" ]; then
            echo "No new files under updates/${DATE}/, skip notify."
            exit 0
          fi

          FILES=$(echo "$NEW_PATHS" \
            | sed -E "s#^updates/${DATE}/##" \
            | sed -E 's/\.[^.]+$//' \
            | sort -u)

          MSG="Êó•ÊúçËá™Âä®ÊäìÂåÖ%0A%0AüìÑ Êõ¥Êñ∞Êñá‰ª∂:%0A"
          while IFS= read -r f; do
            [ -n "$f" ] && MSG="${MSG}${f}%0A"
          done <<< "$FILES"

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHAT_ID}" \
            -d "text=${MSG}" \
            -d "disable_web_page_preview=true"
